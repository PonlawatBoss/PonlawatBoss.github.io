<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการขายฝากที่ดิน/กู้ยืมเงิน</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            animation: fadeInScale 0.3s ease-out;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        /* Status Badges */
        .status-active { background-color: #d1fae5; color: #065f46; } /* Green */
        .status-nearing-due { background-color: #fef9c3; color: #a16207; } /* Yellow */
        .status-overdue { background-color: #fee2e2; color: #991b1b; } /* Red */
        .status-matured { background-color: #e0f2fe; color: #0369a1; } /* Blue */
        .status-redeemed { background-color: #e5e7eb; color: #4b5563; } /* Gray */
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ระบบจัดการขายฝาก/กู้ยืม</h1>
            <nav>
                <ul class="flex space-x-4">
                    <li><button id="navDashboard" class="px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-white font-semibold">หน้าหลัก</button></li>
                    <li><button id="navContracts" class="px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-white font-semibold">จัดการสัญญา</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Dashboard Section -->
        <section id="dashboardSection" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">ภาพรวมระบบ</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-blue-100 p-5 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-blue-700 text-lg font-semibold">จำนวนสัญญา</p>
                        <p id="totalContracts" class="text-blue-900 text-4xl font-bold mt-1">0</p>
                    </div>
                    <i class="fas fa-file-contract text-blue-500 text-5xl opacity-30"></i>
                </div>
                <div class="bg-green-100 p-5 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-green-700 text-lg font-semibold">สัญญาที่ใช้งานอยู่</p>
                        <p id="activeContracts" class="text-green-900 text-4xl font-bold mt-1">0</p>
                    </div>
                    <i class="fas fa-check-circle text-green-500 text-5xl opacity-30"></i>
                </div>
                <div class="bg-yellow-100 p-5 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-yellow-700 text-lg font-semibold">สัญญาเกินกำหนด</p>
                        <p id="overdueContracts" class="text-yellow-900 text-4xl font-bold mt-1">0</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl opacity-30"></i>
                </div>
                <div class="bg-purple-100 p-5 rounded-lg shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-purple-700 text-lg font-semibold">เงินต้นรวมลงทุน</p>
                        <p id="totalInvested" class="text-purple-900 text-4xl font-bold mt-1">0.00 ฿</p>
                    </div>
                    <i class="fas fa-hand-holding-usd text-purple-500 text-5xl opacity-30"></i>
                </div>
                <!-- New: Total Monthly Interest Card -->
                <div class="bg-indigo-100 p-5 rounded-lg shadow-sm flex items-center justify-between md:col-span-2 lg:col-span-2">
                    <div>
                        <p class="text-indigo-700 text-lg font-semibold">ดอกเบี้ยรับต่อเดือน (สัญญาใช้งานอยู่)</p>
                        <p id="totalMonthlyInterest" class="text-indigo-900 text-4xl font-bold mt-1">0.00 ฿</p>
                    </div>
                    <i class="fas fa-sack-dollar text-indigo-500 text-5xl opacity-30"></i>
                </div>
                <!-- End New: Total Monthly Interest Card -->
            </div>

            <h3 class="text-2xl font-bold text-gray-800 mb-4">การแจ้งเตือน</h3>
            <div id="alertList" class="space-y-4">
                <!-- Alerts will be dynamically loaded here -->
                <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 rounded-md shadow-sm" role="alert">
                    <p class="font-bold">ไม่มีการแจ้งเตือนในขณะนี้</p>
                    <p class="text-sm">ข้อมูลล่าสุด ณ ปัจจุบัน</p>
                </div>
            </div>
        </section>

        <!-- Contracts Section -->
        <section id="contractsSection" class="bg-white p-6 rounded-lg shadow-md hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">จัดการสัญญา</h2>
                <button id="addContractBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105">
                    <i class="fas fa-plus-circle mr-2"></i> เพิ่มสัญญาใหม่
                </button>
            </div>

            <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="searchContract" placeholder="ค้นหาด้วยชื่อ, เลขโฉนด, หรือเบอร์โทร" class="p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full">
                <select id="filterStatus" class="p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full">
                    <option value="">ทั้งหมด (สถานะ)</option>
                    <option value="Active">ใช้งานอยู่</option>
                    <option value="Nearing Due">ใกล้ครบกำหนด</option>
                    <option value="Overdue">เกินกำหนดชำระ</option>
                    <option value="Matured">ครบกำหนดไถ่ถอน/คืนเงิน</option>
                    <option value="Redeemed">ไถ่ถอนแล้ว/ชำระคืนแล้ว</option>
                </select>
                <select id="filterType" class="p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full">
                    <option value="">ทั้งหมด (ประเภท)</option>
                    <option value="ขายฝาก">ขายฝาก</option>
                    <option value="กู้ยืม">กู้ยืม</option>
                </select>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">ชื่อลูกหนี้/ผู้ขายฝาก</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">ประเภท</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">เงินต้น</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">กำหนดชำระถัดไป</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">สถานะ</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="contractsTableBody">
                        <!-- Contract rows will be dynamically loaded here -->
                        <tr>
                            <td colspan="6" class="text-center py-4 text-gray-500">ไม่มีข้อมูลสัญญา</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Add/Edit Contract Modal -->
    <div id="contractModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-6">เพิ่มสัญญาใหม่</h3>
            <form id="contractForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="contractId">

                <!-- Borrower/Seller Info -->
                <div class="md:col-span-2 text-lg font-semibold text-gray-700">ข้อมูลลูกหนี้/ผู้ขายฝาก</div>
                <div>
                    <label for="borrowerName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล</label>
                    <input type="text" id="borrowerName" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรศัพท์</label>
                    <input type="tel" id="phoneNumber" maxlength="10" pattern="[0-9]{10}" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="idCard" class="block text-sm font-medium text-gray-700 mb-1">เลขบัตรประชาชน</label>
                    <input type="text" id="idCard" maxlength="13" pattern="[0-9]{13}" title="กรุณากรอกเลขบัตรประชาชน 13 หลัก" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">ที่อยู่</label>
                    <input type="text" id="address" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- New: Broker Name -->
                <div>
                    <label for="brokerName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อนายหน้า</label>
                    <input type="text" id="brokerName" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- End New: Broker Name -->

                <!-- Has Property Selection -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">มีทรัพย์สิน หรือไม่มีทรัพย์สิน</label>
                    <div class="flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="hasProperty" value="true" id="hasPropertyYes" class="form-radio text-blue-600 h-5 w-5">
                            <span class="ml-2 text-gray-700">มีทรัพย์สิน</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="hasProperty" value="false" id="hasPropertyNo" class="form-radio text-blue-600 h-5 w-5" checked>
                            <span class="ml-2 text-gray-700">ไม่มีทรัพย์สิน</span>
                        </label>
                    </div>
                </div>

                <!-- Contract Details -->
                <div class="md:col-span-2 text-lg font-semibold text-gray-700 mt-4">รายละเอียดสัญญา</div>
                <div>
                    <label for="contractType" class="block text-sm font-medium text-gray-700 mb-1">ประเภทสัญญา</label>
                    <select id="contractType" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="ขายฝาก">ขายฝาก</option>
                        <option value="กู้ยืม">กู้ยืม</option>
                    </select>
                </div>
                <div>
                    <label for="principalAmount" class="block text-sm font-medium text-gray-700 mb-1">เงินต้น (฿)</label>
                    <input type="number" id="principalAmount" step="0.01" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="interestRate" class="block text-sm font-medium text-gray-700 mb-1">อัตราดอกเบี้ย (% ต่อเดือน)</label>
                    <input type="number" id="interestRate" step="0.01" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">วันที่ทำสัญญา</label>
                    <input type="date" id="startDate" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">วันที่ครบกำหนด</label>
                    <input type="date" id="endDate" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="paymentFrequency" class="block text-sm font-medium text-gray-700 mb-1">ความถี่การชำระ</label>
                    <select id="paymentFrequency" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="monthly">รายเดือน</option>
                        <option value="quarterly">ราย 3 เดือน</option>
                        <option value="annually">รายปี</option>
                    </select>
                </div>
                <!-- New: Manual Next Payment Due Date -->
                <div>
                    <label for="nextPaymentDueDateManual" class="block text-sm font-medium text-gray-700 mb-1">กำหนดชำระถัดไป (ระบุเอง)</label>
                    <input type="date" id="nextPaymentDueDateManual" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- End New: Manual Next Payment Due Date -->

                <!-- Property Details (Conditional for ขายฝาก and hasProperty) -->
                <div id="propertyDetailsSection" class="md:col-span-2 hidden">
                    <div class="text-lg font-semibold text-gray-700 mt-4">รายละเอียดทรัพย์สิน (สำหรับขายฝาก)</div>
                    <div>
                        <label for="propertyType" class="block text-sm font-medium text-gray-700 mb-1">ประเภททรัพย์สิน</label>
                        <input type="text" id="propertyType" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="เช่น ที่ดินเปล่า, บ้านพร้อมที่ดิน">
                    </div>
                    <div>
                        <label for="landDeedNo" class="block text-sm font-medium text-gray-700 mb-1">เลขโฉนด/เลขที่ดิน</label>
                        <input type="text" id="landDeedNo" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="propertySize" class="block text-sm font-medium text-gray-700 mb-1">ขนาด (เช่น ไร่-งาน-วา)</label>
                        <input type="text" id="propertySize" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="propertyLocation" class="block text-sm font-medium text-gray-700 mb-1">ที่ตั้ง</label>
                        <input type="text" id="propertyLocation" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Property Related Costs -->
                    <div class="md:col-span-2 text-lg font-semibold text-gray-700 mt-4">ต้นทุนที่เกี่ยวข้องกับทรัพย์สิน</div>
                    <div>
                        <label for="transferFee" class="block text-sm font-medium text-gray-700 mb-1">ค่าหักโอน (฿)</label>
                        <input type="number" id="transferFee" step="0.01" value="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="landDeptServiceFee" class="block text-sm font-medium text-gray-700 mb-1">ค่าบริการพนักงานกรมที่ดิน (฿)</label>
                        <input type="number" id="landDeptServiceFee" step="0.01" value="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="brokerageFee" class="block text-sm font-medium text-gray-700 mb-1">ค่านายหน้า (฿)</label>
                        <input type="number" id="brokerageFee" step="0.01" value="0" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- New: Prepaid Interest Months -->
                    <div>
                        <label for="prepaidInterestMonths" class="block text-sm font-medium text-gray-700 mb-1">เก็บอัตราดอกเบี้ยล่วงหน้า</label>
                        <select id="prepaidInterestMonths" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="0">ไม่เก็บล่วงหน้า</option>
                            <option value="1">เก็บล่วงหน้า 1 เดือน</option>
                            <option value="2">เก็บล่วงหน้า 2 เดือน</option>
                            <option value="3">เก็บล่วงหน้า 3 เดือน</option>
                        </select>
                    </div>
                    <!-- End New: Prepaid Interest Months -->

                    <!-- New: Actual Principal Display -->
                    <div class="md:col-span-2 bg-blue-50 p-4 rounded-md border border-blue-200">
                        <p class="text-blue-800 text-lg font-semibold">ต้นทุนที่แท้จริงของสัญญา:</p>
                        <p id="actualPrincipalDisplay" class="text-blue-900 text-3xl font-bold mt-1">0.00 ฿</p>
                    </div>
                    <!-- End New: Actual Principal Display -->
                </div>

                <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelContractModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-md shadow-sm transition-colors">ยกเลิก</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105">บันทึกสัญญา</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">ประวัติการชำระดอกเบี้ย</h3>
            <p class="text-gray-600 mb-4">สัญญา: <span id="paymentModalContractName" class="font-semibold"></span></p>
            <p class="text-gray-600 mb-4">ดอกเบี้ยต่อเดือน: <span id="monthlyInterestAmount" class="font-semibold"></span> ฿</p>

            <div class="mb-6">
                <label for="paymentDate" class="block text-sm font-medium text-gray-700 mb-1">วันที่ชำระ</label>
                <input type="date" id="paymentDate" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-3">
                <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงินที่ชำระ (฿)</label>
                <input type="number" id="paymentAmount" step="0.01" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-3">
                <button id="addPaymentBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-md shadow-sm transition-colors w-full">
                    <i class="fas fa-plus-circle mr-2"></i> บันทึกการชำระ
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white border-collapse">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">วันที่ชำระ</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">จำนวนเงิน (฿)</th>
                            <th class="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryTableBody">
                        <!-- Payment history will be dynamically loaded here -->
                        <tr>
                            <td colspan="3" class="text-center py-4 text-gray-500">ยังไม่มีประวัติการชำระ</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" id="closePaymentHistoryModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-md shadow-sm transition-colors">ปิด</button>
            </div>
        </div>
    </div>

    <!-- LLM Output Modal -->
    <div id="llmOutputModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto modal-content">
            <h3 id="llmModalTitle" class="text-2xl font-bold text-gray-800 mb-6"></h3>
            <div id="llmOutputContent" class="prose max-w-none text-gray-700">
                <!-- LLM generated content will be loaded here -->
                <div class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
                <p class="text-center text-gray-500 mt-4">กำลังสร้างข้อมูล...</p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="closeLlmOutputModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-md shadow-sm transition-colors">ปิด</button>
            </div>
        </div>
    </div>
    <!-- End LLM Output Modal -->

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="confirmModalTitle">ยืนยันการลบ</h3>
            <p class="text-gray-700 mb-6" id="confirmModalMessage">คุณแน่ใจหรือไม่ที่ต้องการลบรายการนี้?</p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelConfirmBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-md shadow-sm transition-colors">ยกเลิก</button>
                <button type="button" id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-md shadow-lg transition-all duration-300 transform hover:scale-105">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Message Box (for alerts/notifications) -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-md shadow-lg hidden z-50 transition-transform transform translate-y-full duration-300 ease-out">
        <p id="messageBoxText"></p>
    </div>

    <footer class="bg-gray-800 text-white p-4 text-center mt-8">
        <div class="container mx-auto">
            <p>&copy; 2024 ระบบจัดการขายฝาก/กู้ยืม. สงวนลิขสิทธิ์.</p>
        </div>
    </footer>

    <script>
        // Global variables for contracts data
        let contracts = [];
        let currentContractIdForPayment = null; // To keep track of which contract's payments are being viewed

        // DOM Elements
        const dashboardSection = document.getElementById('dashboardSection');
        const contractsSection = document.getElementById('contractsSection');
        const navDashboard = document.getElementById('navDashboard');
        const navContracts = document.getElementById('navContracts');

        const totalContractsDisplay = document.getElementById('totalContracts');
        const activeContractsDisplay = document.getElementById('activeContracts');
        const overdueContractsDisplay = document.getElementById('overdueContracts');
        const totalInvestedDisplay = document.getElementById('totalInvested');
        const totalMonthlyInterestDisplay = document.getElementById('totalMonthlyInterest'); // New DOM element
        const alertList = document.getElementById('alertList');

        const addContractBtn = document.getElementById('addContractBtn');
        const contractsTableBody = document.getElementById('contractsTableBody');
        const searchContract = document.getElementById('searchContract');
        const filterStatus = document.getElementById('filterStatus');
        const filterType = document.getElementById('filterType');

        const contractModal = document.getElementById('contractModal');
        const modalTitle = document.getElementById('modalTitle');
        const contractForm = document.getElementById('contractForm');
        const contractIdInput = document.getElementById('contractId');
        const borrowerNameInput = document.getElementById('borrowerName');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const idCardInput = document.getElementById('idCard');
        const addressInput = document.getElementById('address');
        const brokerNameInput = document.getElementById('brokerName');
        const hasPropertyYes = document.getElementById('hasPropertyYes');
        const hasPropertyNo = document.getElementById('hasPropertyNo');
        const contractTypeInput = document.getElementById('contractType');
        const principalAmountInput = document.getElementById('principalAmount');
        const interestRateInput = document.getElementById('interestRate');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const paymentFrequencyInput = document.getElementById('paymentFrequency');
        const nextPaymentDueDateManualInput = document.getElementById('nextPaymentDueDateManual');
        const propertyDetailsSection = document.getElementById('propertyDetailsSection');
        const propertyTypeInput = document.getElementById('propertyType');
        const landDeedNoInput = document.getElementById('landDeedNo');
        const propertySizeInput = document.getElementById('propertySize');
        const propertyLocationInput = document.getElementById('propertyLocation');
        const transferFeeInput = document.getElementById('transferFee');
        const landDeptServiceFeeInput = document.getElementById('landDeptServiceFee');
        const brokerageFeeInput = document.getElementById('brokerageFee');
        const prepaidInterestMonthsInput = document.getElementById('prepaidInterestMonths');
        const actualPrincipalDisplay = document.getElementById('actualPrincipalDisplay');
        const cancelContractModalBtn = document.getElementById('cancelContractModalBtn');

        const paymentHistoryModal = document.getElementById('paymentHistoryModal');
        const paymentModalContractName = document.getElementById('paymentModalContractName');
        const monthlyInterestAmountDisplay = document.getElementById('monthlyInterestAmount');
        const paymentDateInput = document.getElementById('paymentDate');
        const paymentAmountInput = document.getElementById('paymentAmount');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const paymentHistoryTableBody = document.getElementById('paymentHistoryTableBody');
        const closePaymentHistoryModalBtn = document.getElementById('closePaymentHistoryModalBtn');

        const llmOutputModal = document.getElementById('llmOutputModal'); // New DOM element
        const llmModalTitle = document.getElementById('llmModalTitle'); // New DOM element
        const llmOutputContent = document.getElementById('llmOutputContent'); // New DOM element
        const closeLlmOutputModalBtn = document.getElementById('closeLlmOutputModalBtn'); // New DOM element

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');

        const messageBox = document.getElementById('messageBox');
        const messageBoxText = document.getElementById('messageBoxText');

        // --- Utility Functions ---

        /**
         * Generates a unique ID (UUID v4).
         * @returns {string} A unique ID.
         */
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        /**
         * Formats a number as Thai Baht currency.
         * @param {number} amount - The amount to format.
         * @returns {string} Formatted currency string.
         */
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2
            }).format(amount);
        }

        /**
         * Formats a date string to a readable Thai format.
         * @param {string} dateString - The date string (e.g., "YYYY-MM-DD").
         * @returns {string} Formatted date string.
         */
        function formatDate(dateString) {
            if (!dateString) return '-';
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return new Date(dateString).toLocaleDateString('th-TH', options);
        }

        /**
         * Shows a temporary message box.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', 'info'.
         */
        function showMessageBox(message, type = 'info') {
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            messageBox.classList.add('translate-y-0');

            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-blue-600');
            }

            setTimeout(() => {
                messageBox.classList.remove('translate-y-0');
                messageBox.classList.add('translate-y-full');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Allow transition to complete before hiding
            }, 3000);
        }

        // --- Data Management (LocalStorage) ---

        /**
         * Saves the current contracts array to LocalStorage.
         */
        function saveContracts() {
            try {
                localStorage.setItem('mortgageLoanContracts', JSON.stringify(contracts));
                console.log('Contracts saved to LocalStorage.');
            } catch (e) {
                console.error('Error saving to LocalStorage:', e);
                showMessageBox('ข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            }
        }

        /**
         * Loads contracts data from LocalStorage.
         */
        function loadContracts() {
            try {
                const storedData = localStorage.getItem('mortgageLoanContracts');
                contracts = storedData ? JSON.parse(storedData) : [];
                console.log('Contracts loaded from LocalStorage.');
            } catch (e) {
                console.error('Error loading from LocalStorage:', e);
                showMessageBox('ข้อผิดพลาดในการโหลดข้อมูล', 'error');
                contracts = []; // Reset to empty array on error
            }
        }

        // --- Contract Logic ---

        /**
         * Calculates the status of a contract based on its end date and payment history.
         * @param {object} contract - The contract object.
         * @returns {string} The status string ('Active', 'Nearing Due', 'Overdue', 'Matured', 'Redeemed').
         */
        function getContractStatus(contract) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const endDate = new Date(contract.endDate);
            endDate.setHours(0, 0, 0, 0);

            // Check if redeemed first
            if (contract.status === 'Redeemed') {
                return 'Redeemed';
            }

            // Check if matured (end date passed)
            if (today > endDate) {
                return 'Matured';
            }

            // Calculate next payment due date
            let nextDueDate = null;
            if (contract.nextPaymentDueDateManual) {
                nextDueDate = new Date(contract.nextPaymentDueDateManual);
                nextDueDate.setHours(0, 0, 0, 0);
            } else {
                // For automatic calculation based on frequency and last payment
                // This is a simplified logic. A real-world app might need more robust payment tracking.
                // For now, if no manual date, and not matured/redeemed, assume active.
                // More complex logic for 'Nearing Due' and 'Overdue' would involve tracking last payment and frequency.
                // For simplicity, we'll check against end date for 'Nearing Due' for now.
                const oneMonthBeforeEnd = new Date(endDate);
                oneMonthBeforeEnd.setMonth(oneMonthBeforeEnd.getMonth() - 1);
                oneMonthBeforeEnd.setHours(0,0,0,0);

                if (today >= oneMonthBeforeEnd && today <= endDate) {
                    return 'Nearing Due';
                }
            }

            if (nextDueDate && today > nextDueDate) {
                return 'Overdue';
            }

            // If not redeemed, matured, or overdue, it's active
            return 'Active';
        }

        /**
         * Calculates the actual principal amount considering fees and prepaid interest.
         * @param {number} principalAmount - The stated principal amount.
         * @param {number} transferFee - Transfer fee.
         * @param {number} landDeptServiceFee - Land department service fee.
         * @param {number} brokerageFee - Brokerage fee.
         * @param {number} prepaidInterestMonths - Number of months of prepaid interest.
         * @param {number} interestRate - Monthly interest rate percentage.
         * @returns {number} The calculated actual principal.
         */
        function calculateActualPrincipal(principalAmount, transferFee, landDeptServiceFee, brokerageFee, prepaidInterestMonths, interestRate) {
            const parsedPrincipal = parseFloat(principalAmount) || 0;
            const parsedTransferFee = parseFloat(transferFee) || 0;
            const parsedLandDeptServiceFee = parseFloat(landDeptServiceFee) || 0;
            const parsedBrokerageFee = parseFloat(brokerageFee) || 0;
            const parsedPrepaidInterestMonths = parseInt(prepaidInterestMonths) || 0;
            const parsedInterestRate = parseFloat(interestRate) || 0;

            let actualPrincipal = parsedPrincipal;
            actualPrincipal += parsedTransferFee;
            actualPrincipal += parsedLandDeptServiceFee;
            actualPrincipal += parsedBrokerageFee;

            // Subtract prepaid interest from the actual principal received by the borrower
            const monthlyInterest = (parsedPrincipal * (parsedInterestRate / 100));
            actualPrincipal -= (monthlyInterest * parsedPrepaidInterestMonths);

            return actualPrincipal;
        }


        /**
         * Renders the contracts table based on the current contracts data and filters.
         */
        function renderContractsTable() {
            contractsTableBody.innerHTML = ''; // Clear existing rows

            const searchTerm = searchContract.value.toLowerCase();
            const filterStatusValue = filterStatus.value;
            const filterTypeValue = filterType.value;

            const filteredContracts = contracts.filter(contract => {
                const matchesSearch = (
                    contract.borrowerName.toLowerCase().includes(searchTerm) ||
                    (contract.landDeedNo && contract.landDeedNo.toLowerCase().includes(searchTerm)) ||
                    (contract.phoneNumber && contract.phoneNumber.includes(searchTerm))
                );
                const matchesStatus = filterStatusValue === '' || getContractStatus(contract) === filterStatusValue;
                const matchesType = filterTypeValue === '' || contract.contractType === filterTypeValue;

                return matchesSearch && matchesStatus && matchesType;
            });

            if (filteredContracts.length === 0) {
                contractsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-gray-500">ไม่มีข้อมูลสัญญาที่ตรงกับเงื่อนไข</td>
                    </tr>
                `;
                return;
            }

            filteredContracts.forEach(contract => {
                const row = contractsTableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');

                const status = getContractStatus(contract);
                let statusClass = '';
                if (status === 'Active') statusClass = 'status-active';
                else if (status === 'Nearing Due') statusClass = 'status-nearing-due';
                else if (status === 'Overdue') statusClass = 'status-overdue';
                else if (status === 'Matured') statusClass = 'status-matured';
                else if (status === 'Redeemed') statusClass = 'status-redeemed';

                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-800 font-medium">${contract.borrowerName}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${contract.contractType}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${formatCurrency(contract.principalAmount)}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${contract.nextPaymentDueDateManual ? formatDate(contract.nextPaymentDueDateManual) : 'N/A'}</td>
                    <td class="py-3 px-4 text-sm">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                            ${status === 'Active' ? 'ใช้งานอยู่' :
                              status === 'Nearing Due' ? 'ใกล้ครบกำหนด' :
                              status === 'Overdue' ? 'เกินกำหนดชำระ' :
                              status === 'Matured' ? 'ครบกำหนดไถ่ถอน/คืนเงิน' :
                              status === 'Redeemed' ? 'ไถ่ถอนแล้ว/ชำระคืนแล้ว' : status}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm flex flex-wrap gap-2">
                        <button class="text-blue-600 hover:text-blue-800 edit-btn p-1 rounded-md" data-id="${contract.id}" title="แก้ไขสัญญา">
                            <i class="fas fa-edit"></i> แก้ไข
                        </button>
                        <button class="text-green-600 hover:text-green-800 view-payments-btn p-1 rounded-md" data-id="${contract.id}" title="ดูประวัติการชำระ">
                            <i class="fas fa-receipt"></i> ประวัติชำระ
                        </button>
                        <button class="text-red-600 hover:text-red-800 delete-btn p-1 rounded-md" data-id="${contract.id}" title="ลบสัญญา">
                            <i class="fas fa-trash-alt"></i> ลบ
                        </button>
                        <button class="text-purple-600 hover:text-purple-800 summarize-contract-btn p-1 rounded-md" data-id="${contract.id}" title="สรุปสัญญา">
                            <i class="fas fa-lightbulb"></i> สรุปสัญญา ✨
                        </button>
                        <button class="text-orange-600 hover:text-orange-800 draft-reminder-btn p-1 rounded-md" data-id="${contract.id}" title="ร่างแจ้งเตือน">
                            <i class="fas fa-bell"></i> ร่างแจ้งเตือน ✨
                        </button>
                    </td>
                `;
            });

            addContractTableEventListeners();
        }

        /**
         * Adds event listeners to the dynamically created buttons in the contracts table.
         */
        function addContractTableEventListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                // FIX: Changed openEditContractModal to openAddEditContractModal
                button.onclick = (event) => openAddEditContractModal(event.currentTarget.dataset.id);
            });
            document.querySelectorAll('.view-payments-btn').forEach(button => {
                button.onclick = (event) => openPaymentHistoryModal(event.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (event) => confirmDeleteContract(event.currentTarget.dataset.id);
            });
            // New: Event listeners for LLM buttons
            document.querySelectorAll('.summarize-contract-btn').forEach(button => {
                button.onclick = (event) => openLlmOutputModal('summary', event.currentTarget.dataset.id);
            });
            document.querySelectorAll('.draft-reminder-btn').forEach(button => {
                button.onclick = (event) => openLlmOutputModal('reminder', event.currentTarget.dataset.id);
            });
        }

        /**
         * Updates the dashboard summary statistics.
         */
        function updateDashboardSummary() {
            const activeContracts = contracts.filter(c => getContractStatus(c) === 'Active');
            const overdueContracts = contracts.filter(c => getContractStatus(c) === 'Overdue');
            const totalInvested = contracts.reduce((sum, c) => sum + (parseFloat(c.principalAmount) || 0), 0);

            // Calculate total monthly interest from active contracts
            const totalMonthlyInterest = activeContracts.reduce((sum, c) => {
                const principal = parseFloat(c.principalAmount) || 0;
                const interestRate = parseFloat(c.interestRate) || 0;
                return sum + (principal * (interestRate / 100));
            }, 0);

            totalContractsDisplay.textContent = contracts.length;
            activeContractsDisplay.textContent = activeContracts.length;
            overdueContractsDisplay.textContent = overdueContracts.length;
            totalInvestedDisplay.textContent = formatCurrency(totalInvested);
            totalMonthlyInterestDisplay.textContent = formatCurrency(totalMonthlyInterest); // Update new display

            renderAlerts();
        }

        /**
         * Renders alerts based on contract statuses.
         */
        function renderAlerts() {
            alertList.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let hasAlerts = false;

            contracts.forEach(contract => {
                const status = getContractStatus(contract);
                let alertMessage = '';
                let alertClass = '';

                if (status === 'Overdue') {
                    alertMessage = `สัญญาของ ${contract.borrowerName} เกินกำหนดชำระแล้ว!`;
                    alertClass = 'bg-red-50 border-red-400 text-red-700';
                    hasAlerts = true;
                } else if (status === 'Nearing Due') {
                    alertMessage = `สัญญาของ ${contract.borrowerName} ใกล้ครบกำหนดชำระแล้ว!`;
                    alertClass = 'bg-yellow-50 border-yellow-400 text-yellow-700';
                    hasAlerts = true;
                } else if (status === 'Matured') {
                    alertMessage = `สัญญาของ ${contract.borrowerName} ครบกำหนดไถ่ถอน/คืนเงินแล้ว!`;
                    alertClass = 'bg-blue-50 border-blue-400 text-blue-700';
                    hasAlerts = true;
                }

                if (alertMessage) {
                    const alertDiv = document.createElement('div');
                    alertDiv.classList.add('p-4', 'rounded-md', 'shadow-sm', 'border-l-4', alertClass);
                    alertDiv.setAttribute('role', 'alert');
                    alertDiv.innerHTML = `<p class="font-bold">${alertMessage}</p>`;
                    alertList.appendChild(alertDiv);
                }
            });

            if (!hasAlerts) {
                alertList.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 rounded-md shadow-sm" role="alert">
                        <p class="font-bold">ไม่มีการแจ้งเตือนในขณะนี้</p>
                        <p class="text-sm">ข้อมูลล่าสุด ณ ปัจจุบัน</p>
                    </div>
                `;
            }
        }

        // --- Modal Functions ---

        /**
         * Opens the Add/Edit Contract Modal.
         * @param {string|null} contractId - The ID of the contract to edit, or null for a new contract.
         */
        function openAddEditContractModal(contractId = null) {
            contractForm.reset(); // Clear form fields
            contractIdInput.value = ''; // Clear hidden ID

            // Reset property details section visibility and inputs
            propertyDetailsSection.classList.add('hidden');
            propertyTypeInput.value = '';
            landDeedNoInput.value = '';
            propertySizeInput.value = '';
            propertyLocationInput.value = '';
            transferFeeInput.value = '0';
            landDeptServiceFeeInput.value = '0';
            brokerageFeeInput.value = '0';
            prepaidInterestMonthsInput.value = '0';
            actualPrincipalDisplay.textContent = formatCurrency(0);
            hasPropertyNo.checked = true; // Default to no property

            if (contractId) {
                modalTitle.textContent = 'แก้ไขสัญญา';
                const contract = contracts.find(c => c.id === contractId);
                if (contract) {
                    contractIdInput.value = contract.id;
                    borrowerNameInput.value = contract.borrowerName;
                    phoneNumberInput.value = contract.phoneNumber;
                    idCardInput.value = contract.idCard;
                    addressInput.value = contract.address;
                    brokerNameInput.value = contract.brokerName || ''; // Load broker name
                    contractTypeInput.value = contract.contractType;
                    principalAmountInput.value = contract.principalAmount;
                    interestRateInput.value = contract.interestRate;
                    startDateInput.value = contract.startDate;
                    endDateInput.value = contract.endDate;
                    paymentFrequencyInput.value = contract.paymentFrequency;
                    nextPaymentDueDateManualInput.value = contract.nextPaymentDueDateManual || ''; // Load manual due date

                    if (contract.hasProperty === true) {
                        hasPropertyYes.checked = true;
                        propertyDetailsSection.classList.remove('hidden');
                        propertyTypeInput.value = contract.propertyType || '';
                        landDeedNoInput.value = contract.landDeedNo || '';
                        propertySizeInput.value = contract.propertySize || '';
                        propertyLocationInput.value = contract.propertyLocation || '';
                        transferFeeInput.value = contract.transferFee || '0';
                        landDeptServiceFeeInput.value = contract.landDeptServiceFee || '0';
                        brokerageFeeInput.value = contract.brokerageFee || '0';
                        prepaidInterestMonthsInput.value = contract.prepaidInterestMonths || '0';
                    } else {
                        hasPropertyNo.checked = true;
                        propertyDetailsSection.classList.add('hidden');
                    }
                    updateActualPrincipalDisplay(); // Update display on edit
                }
            } else {
                modalTitle.textContent = 'เพิ่มสัญญาใหม่';
                // Set default dates for new contract
                const today = new Date();
                const nextMonth = new Date(today);
                nextMonth.setMonth(today.getMonth() + 1);
                startDateInput.value = today.toISOString().split('T')[0];
                endDateInput.value = nextMonth.toISOString().split('T')[0];
                nextPaymentDueDateManualInput.value = nextMonth.toISOString().split('T')[0]; // Default manual due date
                updateActualPrincipalDisplay(); // Update display for new contract
            }

            contractModal.classList.remove('hidden');
        }

        /**
         * Closes the Add/Edit Contract Modal.
         */
        function closeContractModal() {
            contractModal.classList.add('hidden');
        }

        /**
         * Handles the submission of the contract form.
         * @param {Event} event - The form submission event.
         */
        function handleContractFormSubmit(event) {
            event.preventDefault();

            const id = contractIdInput.value || generateUUID();
            const borrowerName = borrowerNameInput.value.trim();
            const phoneNumber = phoneNumberInput.value.trim();
            const idCard = idCardInput.value.trim();
            const address = addressInput.value.trim();
            const brokerName = brokerNameInput.value.trim();
            const contractType = contractTypeInput.value;
            const principalAmount = parseFloat(principalAmountInput.value);
            const interestRate = parseFloat(interestRateInput.value);
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const paymentFrequency = paymentFrequencyInput.value;
            const nextPaymentDueDateManual = nextPaymentDueDateManualInput.value;
            const hasProperty = hasPropertyYes.checked;

            let propertyType = '';
            let landDeedNo = '';
            let propertySize = '';
            let propertyLocation = '';
            let transferFee = 0;
            let landDeptServiceFee = 0;
            let brokerageFee = 0;
            let prepaidInterestMonths = 0;

            if (hasProperty) {
                propertyType = propertyTypeInput.value.trim();
                landDeedNo = landDeedNoInput.value.trim();
                propertySize = propertySizeInput.value.trim();
                propertyLocation = propertyLocationInput.value.trim();
                transferFee = parseFloat(transferFeeInput.value) || 0;
                landDeptServiceFee = parseFloat(landDeptServiceFeeInput.value) || 0;
                brokerageFee = parseFloat(brokerageFeeInput.value) || 0;
                prepaidInterestMonths = parseInt(prepaidInterestMonthsInput.value) || 0;
            }

            // Basic validation
            if (!borrowerName || isNaN(principalAmount) || principalAmount <= 0 || isNaN(interestRate) || interestRate < 0 || !startDate || !endDate) {
                showMessageBox('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วนและถูกต้อง (ชื่อ, เงินต้น, ดอกเบี้ย, วันที่)', 'error');
                return;
            }

            const newContract = {
                id,
                borrowerName,
                phoneNumber,
                idCard,
                address,
                brokerName, // Save broker name
                hasProperty,
                contractType,
                principalAmount,
                interestRate,
                startDate,
                endDate,
                paymentFrequency,
                nextPaymentDueDateManual, // Save manual due date
                propertyType,
                landDeedNo,
                propertySize,
                propertyLocation,
                transferFee,
                landDeptServiceFee,
                brokerageFee,
                prepaidInterestMonths,
                payments: [], // Initialize payments array
                status: 'Active' // Default status
            };

            const existingIndex = contracts.findIndex(c => c.id === id);
            if (existingIndex > -1) {
                // Update existing contract
                contracts[existingIndex] = { ...contracts[existingIndex], ...newContract };
                showMessageBox('อัปเดตสัญญาเรียบร้อยแล้ว!', 'success');
            } else {
                // Add new contract
                contracts.push(newContract);
                showMessageBox('เพิ่มสัญญาใหม่เรียบร้อยแล้ว!', 'success');
            }

            saveContracts();
            renderContractsTable();
            updateDashboardSummary();
            closeContractModal();
        }

        /**
         * Opens the Payment History Modal for a specific contract.
         * @param {string} contractId - The ID of the contract.
         */
        function openPaymentHistoryModal(contractId) {
            currentContractIdForPayment = contractId;
            const contract = contracts.find(c => c.id === contractId);

            if (contract) {
                paymentModalContractName.textContent = contract.borrowerName;
                const monthlyInterest = (contract.principalAmount * (contract.interestRate / 100)).toFixed(2);
                monthlyInterestAmountDisplay.textContent = formatCurrency(monthlyInterest);
                renderPaymentHistory(contract.payments);
                paymentDateInput.value = new Date().toISOString().split('T')[0]; // Set default payment date to today
                paymentAmountInput.value = monthlyInterest; // Pre-fill with monthly interest

                paymentHistoryModal.classList.remove('hidden');
            } else {
                showMessageBox('ไม่พบสัญญาที่ต้องการดูประวัติการชำระ', 'error');
            }
        }

        /**
         * Closes the Payment History Modal.
         */
        function closePaymentHistoryModal() {
            paymentHistoryModal.classList.add('hidden');
            currentContractIdForPayment = null;
        }

        /**
         * Renders the payment history table for a given contract.
         * @param {Array<object>} payments - Array of payment objects.
         */
        function renderPaymentHistory(payments) {
            paymentHistoryTableBody.innerHTML = '';
            if (payments.length === 0) {
                paymentHistoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center py-4 text-gray-500">ยังไม่มีประวัติการชำระ</td>
                    </tr>
                `;
                return;
            }

            payments.forEach((payment, index) => {
                const row = paymentHistoryTableBody.insertRow();
                row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-800">${formatDate(payment.date)}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${formatCurrency(payment.amount)}</td>
                    <td class="py-3 px-4 text-sm">
                        <button class="text-red-600 hover:text-red-800 delete-payment-btn" data-index="${index}" title="ลบรายการชำระ">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            });

            document.querySelectorAll('.delete-payment-btn').forEach(button => {
                button.onclick = (event) => confirmDeletePayment(event.currentTarget.dataset.index);
            });
        }

        /**
         * Adds a new payment to the current contract's payment history.
         */
        function addPayment() {
            if (!currentContractIdForPayment) {
                showMessageBox('เกิดข้อผิดพลาด: ไม่พบสัญญาที่เลือก', 'error');
                return;
            }

            const paymentDate = paymentDateInput.value;
            const paymentAmount = parseFloat(paymentAmountInput.value);

            if (!paymentDate || isNaN(paymentAmount) || paymentAmount <= 0) {
                showMessageBox('กรุณากรอกวันที่และจำนวนเงินที่ชำระให้ถูกต้อง', 'error');
                return;
            }

            const contractIndex = contracts.findIndex(c => c.id === currentContractIdForPayment);
            if (contractIndex > -1) {
                contracts[contractIndex].payments.push({
                    date: paymentDate,
                    amount: paymentAmount
                });
                saveContracts();
                renderPaymentHistory(contracts[contractIndex].payments);
                showMessageBox('บันทึกการชำระเรียบร้อยแล้ว!', 'success');
            } else {
                showMessageBox('ไม่พบสัญญาที่ต้องการบันทึกการชำระ', 'error');
            }
        }

        /**
         * Shows the confirmation modal for deleting a contract.
         * @param {string} contractId - The ID of the contract to delete.
         */
        function confirmDeleteContract(contractId) {
            confirmModalTitle.textContent = 'ยืนยันการลบสัญญา';
            confirmModalMessage.textContent = 'คุณแน่ใจหรือไม่ที่ต้องการลบสัญญานี้? การดำเนินการนี้ไม่สามารถย้อนกลับได้';
            confirmActionBtn.onclick = () => deleteContract(contractId);
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Shows the confirmation modal for deleting a payment.
         * @param {number} paymentIndex - The index of the payment to delete in the current contract's payments array.
         */
        function confirmDeletePayment(paymentIndex) {
            confirmModalTitle.textContent = 'ยืนยันการลบรายการชำระ';
            confirmModalMessage.textContent = 'คุณแน่ใจหรือไม่ที่ต้องการลบรายการชำระนี้?';
            confirmActionBtn.onclick = () => deletePayment(paymentIndex);
            confirmationModal.classList.remove('hidden');
        }

        /**
         * Deletes a contract by its ID.
         * @param {string} contractId - The ID of the contract to delete.
         */
        function deleteContract(contractId) {
            contracts = contracts.filter(c => c.id !== contractId);
            saveContracts();
            renderContractsTable();
            updateDashboardSummary();
            closeConfirmationModal();
            showMessageBox('ลบสัญญาเรียบร้อยแล้ว!', 'success');
        }

        /**
         * Deletes a payment from the current contract's payment history.
         * @param {number} paymentIndex - The index of the payment to delete.
         */
        function deletePayment(paymentIndex) {
            if (!currentContractIdForPayment) {
                showMessageBox('เกิดข้อผิดพลาด: ไม่พบสัญญาที่เลือก', 'error');
                closeConfirmationModal();
                return;
            }

            const contractIndex = contracts.findIndex(c => c.id === currentContractIdForPayment);
            if (contractIndex > -1) {
                contracts[contractIndex].payments.splice(paymentIndex, 1);
                saveContracts();
                renderPaymentHistory(contracts[contractIndex].payments);
                showMessageBox('ลบรายการชำระเรียบร้อยแล้ว!', 'success');
            } else {
                showMessageBox('ไม่พบสัญญาที่ต้องการลบรายการชำระ', 'error');
            }
            closeConfirmationModal();
        }

        /**
         * Closes the confirmation modal.
         */
        function closeConfirmationModal() {
            confirmationModal.classList.add('hidden');
        }

        /**
         * Updates the "Actual Principal" display in the contract modal.
         */
        function updateActualPrincipalDisplay() {
            const principal = parseFloat(principalAmountInput.value) || 0;
            const transferFee = parseFloat(transferFeeInput.value) || 0;
            const landDeptServiceFee = parseFloat(landDeptServiceFeeInput.value) || 0;
            const brokerageFee = parseFloat(brokerageFeeInput.value) || 0;
            const prepaidInterestMonths = parseInt(prepaidInterestMonthsInput.value) || 0;
            const interestRate = parseFloat(interestRateInput.value) || 0;

            const actualPrincipal = calculateActualPrincipal(principal, transferFee, landDeptServiceFee, brokerageFee, prepaidInterestMonths, interestRate);
            actualPrincipalDisplay.textContent = formatCurrency(actualPrincipal);
        }

        // --- LLM Integration Functions ---

        /**
         * Calls the Gemini API to generate content.
         * @param {string} prompt - The prompt for the LLM.
         * @returns {Promise<string>} The generated text.
         */
        async function callGeminiAPI(prompt) {
            llmOutputContent.innerHTML = `
                <div class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
                <p class="text-center text-gray-500 mt-4">กำลังสร้างข้อมูล...</p>
            `;
            const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error('Unexpected API response structure:', result);
                    return 'ไม่สามารถสร้างข้อมูลได้: โครงสร้างการตอบกลับไม่ถูกต้อง';
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return `เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI: ${error.message}`;
            }
        }

        /**
         * Opens the LLM output modal and generates content based on type.
         * @param {string} type - 'summary' or 'reminder'.
         * @param {string} contractId - The ID of the contract.
         */
        async function openLlmOutputModal(type, contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) {
                showMessageBox('ไม่พบสัญญาที่เลือก', 'error');
                return;
            }

            llmOutputModal.classList.remove('hidden');
            llmOutputContent.innerHTML = `
                <div class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
                <p class="text-center text-gray-500 mt-4">กำลังสร้างข้อมูล...</p>
            `;

            let prompt = '';
            let title = '';

            if (type === 'summary') {
                title = `สรุปสัญญา: ${contract.borrowerName}`;
                prompt = `สรุปรายละเอียดสัญญาขายฝาก/กู้ยืมเงินต่อไปนี้เป็นภาษาไทย:
                ชื่อลูกหนี้/ผู้ขายฝาก: ${contract.borrowerName}
                เบอร์โทรศัพท์: ${contract.phoneNumber}
                เลขบัตรประชาชน: ${contract.idCard}
                ที่อยู่: ${contract.address}
                ชื่อนายหน้า: ${contract.brokerName || 'ไม่มี'}
                ประเภทสัญญา: ${contract.contractType}
                เงินต้น: ${contract.principalAmount} บาท
                อัตราดอกเบี้ย: ${contract.interestRate}% ต่อเดือน
                วันที่ทำสัญญา: ${formatDate(contract.startDate)}
                วันที่ครบกำหนด: ${formatDate(contract.endDate)}
                ความถี่การชำระ: ${contract.paymentFrequency === 'monthly' ? 'รายเดือน' : contract.paymentFrequency === 'quarterly' ? 'ราย 3 เดือน' : 'รายปี'}
                กำหนดชำระถัดไป (ระบุเอง): ${contract.nextPaymentDueDateManual ? formatDate(contract.nextPaymentDueDateManual) : 'ไม่มี'}
                มีทรัพย์สินค้ำประกัน: ${contract.hasProperty ? 'มี' : 'ไม่มี'}
                ${contract.hasProperty ? `
                ประเภททรัพย์สิน: ${contract.propertyType || 'ไม่ระบุ'}
                เลขโฉนด/เลขที่ดิน: ${contract.landDeedNo || 'ไม่ระบุ'}
                ขนาด: ${contract.propertySize || 'ไม่ระบุ'}
                ที่ตั้ง: ${contract.propertyLocation || 'ไม่ระบุ'}
                ค่าหักโอน: ${contract.transferFee || 0} บาท
                ค่าบริการพนักงานกรมที่ดิน: ${contract.landDeptServiceFee || 0} บาท
                ค่านายหน้า: ${contract.brokerageFee || 0} บาท
                เก็บอัตราดอกเบี้ยล่วงหน้า: ${contract.prepaidInterestMonths || 0} เดือน
                ` : ''}
                ประวัติการชำระ: ${contract.payments && contract.payments.length > 0 ? contract.payments.map(p => `${formatDate(p.date)}: ${formatCurrency(p.amount)}`).join(', ') : 'ยังไม่มีประวัติ'}
                สถานะปัจจุบัน: ${getContractStatus(contract)}

                โปรดสรุปเป็นข้อๆ ที่เข้าใจง่ายและเน้นข้อมูลสำคัญ เช่น เงินต้น, ดอกเบี้ย, วันครบกำหนด, และสถานะปัจจุบัน
                `;
            } else if (type === 'reminder') {
                title = `ร่างแจ้งเตือนการชำระเงิน: ${contract.borrowerName}`;
                const monthlyInterestAmount = (contract.principalAmount * (contract.interestRate / 100)).toFixed(2);
                prompt = `ร่างข้อความแจ้งเตือนการชำระเงินสำหรับสัญญาต่อไปนี้เป็นภาษาไทย โดยเน้นความสุภาพและชัดเจน:
                ชื่อลูกหนี้/ผู้ขายฝาก: ${contract.borrowerName}
                เบอร์โทรศัพท์: ${contract.phoneNumber}
                ประเภทสัญญา: ${contract.contractType}
                เงินต้น: ${contract.principalAmount} บาท
                อัตราดอกเบี้ย: ${contract.interestRate}% ต่อเดือน
                วันที่ทำสัญญา: ${formatDate(contract.startDate)}
                วันที่ครบกำหนด: ${formatDate(contract.endDate)}
                กำหนดชำระถัดไป: ${contract.nextPaymentDueDateManual ? formatDate(contract.nextPaymentDueDateManual) : 'โปรดระบุ'}
                ยอดดอกเบี้ยที่ต้องชำระ: ${monthlyInterestAmount} บาท

                โปรดสร้างข้อความที่สามารถส่งผ่านช่องทางเช่น SMS หรือ Line ได้ โดยไม่ต้องมีคำทักทายหรือลงท้ายยาวๆ และสามารถคัดลอกไปใช้ได้ทันที
                `;
            }

            llmModalTitle.textContent = title;
            const generatedText = await callGeminiAPI(prompt);
            llmOutputContent.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-base">${generatedText}</pre>`;
        }

        /**
         * Closes the LLM output modal.
         */
        function closeLlmOutputModal() {
            llmOutputModal.classList.add('hidden');
            llmOutputContent.innerHTML = `
                <div class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
                </div>
                <p class="text-center text-gray-500 mt-4">กำลังสร้างข้อมูล...</p>
            `; // Reset content
        }

        // --- Event Listeners ---

        // Navigation
        navDashboard.addEventListener('click', () => {
            dashboardSection.classList.remove('hidden');
            contractsSection.classList.add('hidden');
            updateDashboardSummary(); // Ensure dashboard is updated when navigating to it
        });

        navContracts.addEventListener('click', () => {
            contractsSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            renderContractsTable(); // Ensure contracts table is rendered when navigating to it
        });

        // Contract Modal
        addContractBtn.addEventListener('click', () => openAddEditContractModal());
        cancelContractModalBtn.addEventListener('click', closeContractModal);
        contractForm.addEventListener('submit', handleContractFormSubmit);

        // Property Details Visibility
        hasPropertyYes.addEventListener('change', () => {
            propertyDetailsSection.classList.remove('hidden');
            updateActualPrincipalDisplay();
        });
        hasPropertyNo.addEventListener('change', () => {
            propertyDetailsSection.classList.add('hidden');
            updateActualPrincipalDisplay(); // Update even if hidden, to reset calculation
        });

        // Recalculate Actual Principal on input change
        principalAmountInput.addEventListener('input', updateActualPrincipalDisplay);
        transferFeeInput.addEventListener('input', updateActualPrincipalDisplay);
        landDeptServiceFeeInput.addEventListener('input', updateActualPrincipalDisplay);
        brokerageFeeInput.addEventListener('input', updateActualPrincipalDisplay);
        prepaidInterestMonthsInput.addEventListener('change', updateActualPrincipalDisplay);
        interestRateInput.addEventListener('input', updateActualPrincipalDisplay); // Interest rate also affects actual principal due to prepaid interest

        // Payment History Modal
        addPaymentBtn.addEventListener('click', addPayment);
        closePaymentHistoryModalBtn.addEventListener('click', closePaymentHistoryModal);

        // LLM Output Modal
        closeLlmOutputModalBtn.addEventListener('click', closeLlmOutputModal); // New event listener

        // Confirmation Modal
        cancelConfirmBtn.addEventListener('click', closeConfirmationModal);

        // Filters and Search
        searchContract.addEventListener('input', renderContractsTable);
        filterStatus.addEventListener('change', renderContractsTable);
        filterType.addEventListener('change', renderContractsTable);

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadContracts();
            updateDashboardSummary();
            renderContractsTable(); // Render contracts table initially (it will be hidden by default)
            navDashboard.click(); // Show dashboard by default
        });
    </script>
</body>
</html>
